{% extends "base.html" %}

{% block title %}Analytics - Lode{% endblock %}

{% block content %}
<div class="menu-bar">
    <h1>Lode</h1>
    <div class="menu-items">
        <a href="/main">Main</a>
        <a href="/import">Import</a>
        <a href="/analytics">Analytics</a>
        <a href="/find-tools">Find Tools</a>
        <a href="/export">Export</a>
        <a href="/settings">Settings</a>
        <a href="/help">Help</a>
        <a href="/about">About</a>
    </div>
</div>

<div class="container">
    <div class="card">
        <h2>Analytics</h2>
        
        <div class="tabs" style="border-bottom: 1px solid #ddd; margin-bottom: 20px;">
            <button class="tab-btn active" onclick="showTab('usage')">Usage</button>
            <button class="tab-btn" onclick="showTab('streaks')">Streaks</button>
            <button class="tab-btn" onclick="showTab('words')">Top Words</button>
            <button class="tab-btn" onclick="showTab('phrases')">Top Phrases</button>
            <button class="tab-btn" onclick="showTab('vocabulary')">Vocabulary</button>
            <button class="tab-btn" onclick="showTab('response')">Response Ratio</button>
            <button class="tab-btn" onclick="showTab('heatmap')">Time of Day</button>
        </div>
        
        <div style="margin-bottom: 20px; text-align: right;">
            <button onclick="refreshAllAnalytics()" class="btn btn-primary">Refresh All Analytics</button>
        </div>
        
        <div id="tab-content">
            <div id="usage-tab" class="tab-panel active">
                <h3>Usage Over Time</h3>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Period</label>
                    <select id="usage-period" onchange="loadUsage()">
                        <option value="day">Day</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                </div>
                <div id="usage-data" class="loading">Loading...</div>
            </div>
            
            <div id="streaks-tab" class="tab-panel">
                <h3>Longest Streak</h3>
                <div id="streaks-data" class="loading">Loading...</div>
            </div>
            
            <div id="words-tab" class="tab-panel">
                <h3>Top Words</h3>
                <div id="words-data" class="loading">Loading...</div>
            </div>
            
            <div id="phrases-tab" class="tab-panel">
                <h3>Top Phrases</h3>
                <div id="phrases-data" class="loading">Loading...</div>
            </div>
            
            <div id="vocabulary-tab" class="tab-panel">
                <h3>Vocabulary Trend</h3>
                <div id="vocabulary-data" class="loading">Loading...</div>
            </div>
            
            <div id="response-tab" class="tab-panel">
                <h3>Response Ratio</h3>
                <div id="response-data" class="loading">Loading...</div>
            </div>
            
            <div id="heatmap-tab" class="tab-panel">
                <h3>Time of Day Heatmap</h3>
                <div id="heatmap-data" class="loading">Loading...</div>
            </div>
        </div>
    </div>
</div>

<style>
.tabs {
    display: flex;
    gap: 10px;
}

.tab-btn {
    padding: 8px 16px;
    border: none;
    background: transparent;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}

.tab-btn:hover {
    background: #f5f5f5;
}

.tab-btn.active {
    border-bottom-color: #3498db;
    color: #3498db;
}

.tab-panel {
    display: none;
}

.tab-panel.active {
    display: block;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

table th, table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

table th {
    background: #f8f9fa;
    font-weight: 600;
}
</style>

<script>
// Cache for analytics data
const analyticsCache = {
    usage: {},
    streaks: null,
    words: null,
    phrases: null,
    vocabulary: null,
    response: null,
    heatmap: null
};

function clearAnalyticsCache() {
    analyticsCache.usage = {};
    analyticsCache.streaks = null;
    analyticsCache.words = null;
    analyticsCache.phrases = null;
    analyticsCache.vocabulary = null;
    analyticsCache.response = null;
    analyticsCache.heatmap = null;
}

function refreshAllAnalytics() {
    clearAnalyticsCache();
    // Reload current tab
    const activeTab = document.querySelector('.tab-btn.active');
    if (activeTab) {
        const tabName = activeTab.textContent.toLowerCase().replace(/\s+/g, '');
        if (tabName.includes('usage')) {
            loadUsage(true);
        } else if (tabName.includes('streak')) {
            loadStreaks(true);
        } else if (tabName.includes('word')) {
            loadWords(true);
        } else if (tabName.includes('phrase')) {
            loadPhrases(true);
        } else if (tabName.includes('vocab')) {
            loadVocabulary(true);
        } else if (tabName.includes('response')) {
            loadResponseRatio(true);
        } else if (tabName.includes('time') || tabName.includes('heatmap')) {
            loadHeatmap(true);
        }
    }
}

function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`${tabName}-tab`).classList.add('active');
    event.target.classList.add('active');
    
    // Load data for the tab (from cache if available)
    if (tabName === 'usage') {
        loadUsage(false);
    } else if (tabName === 'streaks') {
        loadStreaks(false);
    } else if (tabName === 'words') {
        loadWords(false);
    } else if (tabName === 'phrases') {
        loadPhrases(false);
    } else if (tabName === 'vocabulary') {
        loadVocabulary(false);
    } else if (tabName === 'response') {
        loadResponseRatio(false);
    } else if (tabName === 'heatmap') {
        loadHeatmap(false);
    }
}

async function loadUsage(forceRefresh = false) {
    const period = document.getElementById('usage-period').value;
    const div = document.getElementById('usage-data');
    
    // Check cache first
    if (!forceRefresh && analyticsCache.usage[period]) {
        renderUsageData(analyticsCache.usage[period], div);
        return;
    }
    
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch(`/api/analytics/usage?period=${period}`);
        const data = await response.json();
        
        // Cache the data
        analyticsCache.usage[period] = data;
        
        renderUsageData(data, div);
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

function renderUsageData(data, div) {
    if (data.length === 0) {
        div.innerHTML = '<div class="empty-state">No data available</div>';
        return;
    }
    
    let html = '<table><tr><th>Date</th><th>Conversations</th><th>Messages</th><th>Words</th></tr>';
    data.forEach(row => {
        html += `<tr>
            <td>${row.period || row.date || ''}</td>
            <td>${row.conversation_count || 0}</td>
            <td>${row.message_count || 0}</td>
            <td>${row.word_count || 0}</td>
        </tr>`;
    });
    html += '</table>';
    div.innerHTML = html;
}

async function loadStreaks(forceRefresh = false) {
    const div = document.getElementById('streaks-data');
    
    // Check cache first
    if (!forceRefresh && analyticsCache.streaks !== null) {
        renderStreaksData(analyticsCache.streaks, div);
        return;
    }
    
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/analytics/streaks');
        const data = await response.json();
        
        // Cache the data
        analyticsCache.streaks = data;
        
        renderStreaksData(data, div);
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

function renderStreaksData(data, div) {
    if (!data || Object.keys(data).length === 0) {
        div.innerHTML = '<div class="empty-state">No streak data available</div>';
        return;
    }
    
    let html = '<table><tr><th>Metric</th><th>Value</th></tr>';
    Object.entries(data).forEach(([key, value]) => {
        html += `<tr><td>${key.replace(/_/g, ' ')}</td><td>${value}</td></tr>`;
    });
    html += '</table>';
    div.innerHTML = html;
}

async function loadWords(forceRefresh = false) {
    const div = document.getElementById('words-data');
    
    // Check cache first
    if (!forceRefresh && analyticsCache.words !== null) {
        renderWordsData(analyticsCache.words, div);
        return;
    }
    
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/analytics/top-words?limit=50');
        const data = await response.json();
        
        // Cache the data
        analyticsCache.words = data;
        
        renderWordsData(data, div);
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

function renderWordsData(data, div) {
    if (data.length === 0) {
        div.innerHTML = '<div class="empty-state">No word data available</div>';
        return;
    }
    
    let html = '<table><tr><th>Word</th><th>Count</th></tr>';
    data.forEach(row => {
        html += `<tr><td>${row.word || row.text || ''}</td><td>${row.count || 0}</td></tr>`;
    });
    html += '</table>';
    div.innerHTML = html;
}

async function loadPhrases(forceRefresh = false) {
    const div = document.getElementById('phrases-data');
    
    // Check cache first
    if (!forceRefresh && analyticsCache.phrases !== null) {
        renderPhrasesData(analyticsCache.phrases, div);
        return;
    }
    
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/analytics/top-phrases?limit=30');
        const data = await response.json();
        
        // Cache the data
        analyticsCache.phrases = data;
        
        renderPhrasesData(data, div);
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

function renderPhrasesData(data, div) {
    if (data.length === 0) {
        div.innerHTML = '<div class="empty-state">No phrase data available</div>';
        return;
    }
    
    let html = '<table><tr><th>Phrase</th><th>Count</th></tr>';
    data.forEach(row => {
        html += `<tr><td>${row.phrase || row.text || ''}</td><td>${row.count || 0}</td></tr>`;
    });
    html += '</table>';
    div.innerHTML = html;
}

async function loadVocabulary(forceRefresh = false) {
    const div = document.getElementById('vocabulary-data');
    
    // Check cache first
    if (!forceRefresh && analyticsCache.vocabulary !== null) {
        renderVocabularyData(analyticsCache.vocabulary, div);
        return;
    }
    
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/analytics/vocabulary');
        const data = await response.json();
        
        // Cache the data
        analyticsCache.vocabulary = data;
        
        renderVocabularyData(data, div);
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

function renderVocabularyData(data, div) {
    if (!data || !Array.isArray(data) || data.length === 0) {
        div.innerHTML = '<div class="empty-state">No vocabulary data available</div>';
        return;
    }
    
    let html = '<table><tr><th>Period</th><th>Unique Words</th></tr>';
    data.forEach(row => {
        html += `<tr><td>${row.period || ''}</td><td>${row.unique_words || 0}</td></tr>`;
    });
    html += '</table>';
    div.innerHTML = html;
}

async function loadResponseRatio(forceRefresh = false) {
    const div = document.getElementById('response-data');
    
    // Check cache first
    if (!forceRefresh && analyticsCache.response !== null) {
        renderResponseRatioData(analyticsCache.response, div);
        return;
    }
    
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/analytics/response-ratio');
        const data = await response.json();
        
        // Cache the data
        analyticsCache.response = data;
        
        renderResponseRatioData(data, div);
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

function renderResponseRatioData(data, div) {
    if (!data || Object.keys(data).length === 0) {
        div.innerHTML = '<div class="empty-state">No response ratio data available</div>';
        return;
    }
    
    let html = '<table><tr><th>Metric</th><th>Value</th></tr>';
    Object.entries(data).forEach(([key, value]) => {
        html += `<tr><td>${key.replace(/_/g, ' ')}</td><td>${value}</td></tr>`;
    });
    html += '</table>';
    div.innerHTML = html;
}

async function loadHeatmap(forceRefresh = false) {
    const div = document.getElementById('heatmap-data');
    
    // Check cache first
    if (!forceRefresh && analyticsCache.heatmap !== null) {
        renderHeatmapData(analyticsCache.heatmap, div);
        return;
    }
    
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/analytics/heatmap');
        const data = await response.json();
        
        // Cache the data
        analyticsCache.heatmap = data;
        
        renderHeatmapData(data, div);
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

function renderHeatmapData(data, div) {
    if (data.length === 0) {
        div.innerHTML = '<div class="empty-state">No heatmap data available</div>';
        return;
    }
    
    // Find max count for scaling
    const maxCount = Math.max(...data.map(row => row.count || 0), 1);
    
    // Create graph at top
    let html = '<div style="margin-bottom: 30px;"><h4>Message Count by Hour</h4>';
    html += '<div style="display: flex; align-items: flex-end; gap: 4px; height: 200px; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 20px;">';
    
    data.forEach(row => {
        const count = row.count || 0;
        const heightPercent = maxCount > 0 ? (count / maxCount) * 100 : 0;
        const heightPx = (heightPercent / 100) * 200; // Convert to pixels based on container height
        const hourLabel = row.hour_label || row.hour || '';
        html += `<div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">`;
        html += `<div style="background: #3498db; width: 100%; height: ${heightPx}px; min-height: ${count > 0 ? '2px' : '0'}; border-radius: 2px 2px 0 0; margin-bottom: 5px;" title="${hourLabel}: ${count} messages"></div>`;
        html += `<div style="font-size: 11px; color: #7f8c8d; transform: rotate(-45deg); transform-origin: center; white-space: nowrap; margin-top: 5px;">${hourLabel}</div>`;
        html += `</div>`;
    });
    html += '</div></div>';
    
    // Keep the list table
    html += '<h4>Detailed List</h4><table><tr><th>Hour</th><th>Count</th></tr>';
    data.forEach(row => {
        const hourLabel = row.hour_label || row.hour || '';
        html += `<tr><td>${hourLabel}</td><td>${row.count || 0}</td></tr>`;
    });
    html += '</table>';
    div.innerHTML = html;
}

// Load initial tab
loadUsage();
</script>
{% endblock %}

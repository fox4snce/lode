{% extends "base.html" %}

{% block title %}Settings - Lode{% endblock %}

{% block content %}
<div class="menu-bar">
    <h1>Lode</h1>
    <div class="menu-items">
        <a href="/main">Main</a>
        <a href="/import">Import</a>
        <a href="/analytics">Analytics</a>
        <a href="/find-tools">Find Tools</a>
        <a href="/vectordb-search">Vector Search</a>
        <a href="/export">Export</a>
        <a href="/settings">Settings</a>
        <a href="/help">Help</a>
        <a href="/about">About</a>
    </div>
</div>

<div class="container">
    <div class="card">
        <h2>Settings</h2>
        
        <div class="tabs" style="border-bottom: 1px solid #ddd; margin-bottom: 20px;">
            <button class="tab-btn active" onclick="showTab('server')">Server</button>
            <button class="tab-btn" onclick="showTab('integrity')">Integrity Checks</button>
            <button class="tab-btn" onclick="showTab('deduplication')">Deduplication</button>
            <button class="tab-btn" onclick="showTab('cleanup')">Cleanup</button>
            <button class="tab-btn" onclick="showTab('encryption')">Encryption</button>
        </div>
        
        <div id="tab-content">
            <div id="server-tab" class="tab-panel active">
                <h3>Server Settings</h3>
                <p>Configure the FastAPI server port. The VectorDB API and all other APIs run on this port.</p>
                <div style="margin-bottom: 20px;">
                    <label for="server-port" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        Server Port:
                    </label>
                    <input 
                        type="number" 
                        id="server-port" 
                        min="1024" 
                        max="65535" 
                        style="width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                    />
                    <button onclick="saveServerPort()" class="btn btn-primary" style="margin-left: 10px;">Save</button>
                </div>
                <div id="server-message" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
                <div style="margin-top: 20px; padding: 12px; background: #f8f9fa; border-radius: 4px; font-size: 13px; color: #666;">
                    <strong>Note:</strong> Changes to the port require restarting Lode to take effect.
                    <br>If the port is already in use, you'll see an error message when starting Lode.
                </div>
            </div>
            
            <div id="integrity-tab" class="tab-panel">
                <h3>Integrity Checks</h3>
                <p>Run integrity checks to verify database consistency.</p>
                <button onclick="runIntegrityChecks()" class="btn btn-primary">Run Integrity Checks</button>
                <div id="integrity-result" style="margin-top: 20px;"></div>
            </div>
            
            <div id="deduplication-tab" class="tab-panel">
                <h3>Deduplication</h3>
                <p>Find and remove duplicate messages or conversations.</p>
                <div style="margin-bottom: 15px;">
                    <button onclick="findDuplicateMessages()" class="btn btn-primary">Find Duplicate Messages</button>
                    <button onclick="findDuplicateConversations()" class="btn btn-primary" style="margin-left: 10px;">Find Duplicate Conversations</button>
                </div>
                <div id="deduplication-result" style="margin-top: 20px;"></div>
            </div>
            
            <div id="cleanup-tab" class="tab-panel">
                <h3>Cleanup</h3>
                <p>Clean up imported files and temporary data.</p>
                <button onclick="wipeImportedFiles()" class="btn btn-danger">Wipe Imported Files</button>
                <div id="cleanup-result" style="margin-top: 20px;"></div>
            </div>
            
            <div id="encryption-tab" class="tab-panel">
                <h3>Encryption</h3>
                <p>Encryption features coming soon...</p>
            </div>
        </div>
    </div>
</div>

<style>
.tabs {
    display: flex;
    gap: 10px;
}

.tab-btn {
    padding: 8px 16px;
    border: none;
    background: transparent;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}

.tab-btn:hover {
    background: #f5f5f5;
}

.tab-btn.active {
    border-bottom-color: #3498db;
    color: #3498db;
}

.tab-panel {
    display: none;
}

.tab-panel.active {
    display: block;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

table th, table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

table th {
    background: #f8f9fa;
    font-weight: 600;
}
</style>

<script>
// Load server port on page load
document.addEventListener('DOMContentLoaded', function() {
    loadServerPort();
});

async function loadServerPort() {
    try {
        const response = await fetch('/api/config/port');
        const data = await response.json();
        document.getElementById('server-port').value = data.port || 8000;
    } catch (error) {
        console.error('Failed to load server port:', error);
        document.getElementById('server-port').value = 8000;
    }
}

async function saveServerPort() {
    const portInput = document.getElementById('server-port');
    const port = parseInt(portInput.value);
    const messageDiv = document.getElementById('server-message');
    
    if (isNaN(port) || port < 1024 || port > 65535) {
        messageDiv.style.display = 'block';
        messageDiv.className = 'error';
        messageDiv.textContent = 'Please enter a valid port number (1024-65535)';
        return;
    }
    
    try {
        const response = await fetch('/api/config/port', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ port: port })
        });
        
        if (response.ok) {
            messageDiv.style.display = 'block';
            messageDiv.className = 'success';
            messageDiv.textContent = `Port ${port} saved. Please restart Lode for changes to take effect.`;
        } else {
            const data = await response.json();
            messageDiv.style.display = 'block';
            messageDiv.className = 'error';
            messageDiv.textContent = data.detail || 'Failed to save port';
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.className = 'error';
        messageDiv.textContent = `Error: ${error.message}`;
    }
}

function showTab(tabName) {
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(`${tabName}-tab`).classList.add('active');
    event.target.classList.add('active');
}

async function runIntegrityChecks() {
    const resultDiv = document.getElementById('integrity-result');
    resultDiv.innerHTML = '<div class="loading">Running integrity checks...</div>';
    
    try {
        const response = await fetch('/api/integrity/check', { method: 'GET' });
        const data = await response.json();
        
        if (!data || Object.keys(data).length === 0) {
            resultDiv.innerHTML = '<div class="success">All integrity checks passed!</div>';
            return;
        }
        
        // Extract summary if present
        const summary = data.summary || {};
        const hasIssues = summary.has_issues || false;
        const totalIssues = summary.total_issues || 0;
        
        // Remove summary from display (it's metadata)
        const checks = { ...data };
        delete checks.summary;
        
        // Check if there are any real issues
        let anyRealIssues = false;
        Object.values(checks).forEach(value => {
            if (Array.isArray(value) && value.length > 0) {
                anyRealIssues = true;
            } else if (typeof value === 'object' && value !== null) {
                // Check for count fields or non-empty arrays
                if (value.count > 0) anyRealIssues = true;
                if (Array.isArray(value.conversations) && value.conversations.length > 0) anyRealIssues = true;
                if (Array.isArray(value.messages) && value.messages.length > 0) anyRealIssues = true;
            }
        });
        
        if (!anyRealIssues && !hasIssues) {
            resultDiv.innerHTML = '<div class="success">All integrity checks passed!</div>';
            return;
        }
        
        let html = `<div class="error">Integrity check found ${totalIssues} issue${totalIssues !== 1 ? 's' : ''}:</div>`;
        html += '<table><tr><th>Check</th><th>Status</th><th>Details</th></tr>';
        
        Object.entries(checks).forEach(([key, value]) => {
            let hasIssues = false;
            let details = '';
            
            if (Array.isArray(value)) {
                hasIssues = value.length > 0;
                if (hasIssues) {
                    details = `${value.length} issue${value.length !== 1 ? 's' : ''} found`;
                    if (value.length <= 5) {
                        details += ': ' + value.map(v => {
                            if (v.conversation_id && v.message_id) {
                                return `${v.conversation_id}/${v.message_id}`;
                            }
                            return JSON.stringify(v);
                        }).join(', ');
                    }
                } else {
                    details = 'None';
                }
            } else if (typeof value === 'object' && value !== null) {
                const count = value.count || 0;
                const convCount = Array.isArray(value.conversations) ? value.conversations.length : 0;
                const msgCount = Array.isArray(value.messages) ? value.messages.length : 0;
                hasIssues = count > 0 || convCount > 0 || msgCount > 0;
                
                if (hasIssues) {
                    const parts = [];
                    if (count > 0) parts.push(`Total: ${count}`);
                    if (convCount > 0) parts.push(`Conversations: ${convCount}`);
                    if (msgCount > 0) parts.push(`Messages: ${msgCount}`);
                    details = parts.join(', ');
                } else {
                    details = 'None';
                }
            } else {
                hasIssues = !(value === true || value === 'ok');
                details = JSON.stringify(value);
            }
            
            const status = hasIssues ? '<span style="color: #e74c3c;">✗ Fail</span>' : '<span style="color: #27ae60;">✓ Pass</span>';
            const checkName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `<tr><td>${checkName}</td><td>${status}</td><td>${details}</td></tr>`;
        });
        
        html += '</table>';
        resultDiv.innerHTML = html;
    } catch (error) {
        resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function findDuplicateMessages() {
    const resultDiv = document.getElementById('deduplication-result');
    resultDiv.innerHTML = '<div class="loading">Finding duplicate messages...</div>';
    
    try {
        const response = await fetch('/api/deduplication/find-messages');
        const data = await response.json();
        
        if (data.length === 0) {
            resultDiv.innerHTML = '<div class="success">No duplicate messages found!</div>';
            return;
        }
        
        let totalDuplicates = 0;
        data.forEach(group => {
            totalDuplicates += group.count || 0;
        });
        
        let html = `<div class="error">Found ${data.length} duplicate message group${data.length !== 1 ? 's' : ''} (${totalDuplicates} total duplicate messages):</div>`;
        html += '<table><tr><th>Group</th><th>Count</th><th>Messages</th><th>Content Preview</th></tr>';
        
        data.forEach((group, groupIndex) => {
            const messages = group.messages || [];
            const firstMessage = messages[0] || {};
            const content = (firstMessage.content || '').substring(0, 150);
            const contentPreview = content.length > 150 ? content + '...' : content;
            
            // Show all messages in the group
            const messageList = messages.map(msg => {
                return `${msg.conversation_id || '?'}/${msg.message_id || '?'}`;
            }).join(', ');
            
            html += `<tr>`;
            html += `<td>Group ${groupIndex + 1}</td>`;
            html += `<td>${group.count || messages.length}</td>`;
            html += `<td style="font-size: 12px; color: #7f8c8d;">${messageList}</td>`;
            html += `<td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(contentPreview)}</td>`;
            html += `</tr>`;
        });
        
        html += '</table>';
        resultDiv.innerHTML = html;
    } catch (error) {
        resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
    }
}

async function findDuplicateConversations() {
    const resultDiv = document.getElementById('deduplication-result');
    resultDiv.innerHTML = '<div class="loading">Finding duplicate conversations...</div>';
    
    try {
        const response = await fetch('/api/deduplication/find-conversations');
        const data = await response.json();
        
        if (data.length === 0) {
            resultDiv.innerHTML = '<div class="success">No duplicate conversations found!</div>';
            return;
        }
        
        let html = `<div class="error">Found ${data.length} duplicate conversation group${data.length !== 1 ? 's' : ''}:</div>`;
        html += '<table><tr><th>Group</th><th>Count</th><th>Conversation IDs</th><th>Titles</th></tr>';
        
        data.forEach((group, groupIndex) => {
            const conversations = group.conversations || [];
            const convIds = conversations.map(c => c.conversation_id || '?').join(', ');
            const titles = conversations.map(c => c.title || '(no title)').join('; ');
            
            html += `<tr>`;
            html += `<td>Group ${groupIndex + 1}</td>`;
            html += `<td>${group.count || conversations.length}</td>`;
            html += `<td style="font-size: 12px; color: #7f8c8d;">${convIds}</td>`;
            html += `<td>${escapeHtml(titles)}</td>`;
            html += `</tr>`;
        });
        
        html += '</table>';
        resultDiv.innerHTML = html;
    } catch (error) {
        resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
    }
}

async function wipeImportedFiles() {
    // Create a custom confirmation dialog
    const confirmed = await new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
        
        const dialog = document.createElement('div');
        dialog.style.cssText = 'background: white; padding: 30px; border-radius: 8px; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
        
        dialog.innerHTML = `
            <h2 style="margin: 0 0 15px 0; color: #e74c3c;">⚠️ WARNING</h2>
            <p style="margin: 0 0 20px 0; font-size: 16px; line-height: 1.5;">
                <strong>Are you sure you want to wipe all imported files?</strong>
            </p>
            <p style="margin: 0 0 20px 0; color: #e74c3c; font-weight: bold; font-size: 14px;">
                ALL DATA WILL BE DELETED
            </p>
            <p style="margin: 0 0 20px 0; font-size: 14px; color: #7f8c8d;">
                This action cannot be undone. All imported source files AND all data in the database (conversations, messages, etc.) will be permanently deleted.
            </p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="cancel-wipe" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
                <button id="confirm-wipe" style="padding: 10px 20px; border: none; background: #e74c3c; color: white; border-radius: 4px; cursor: pointer; font-weight: bold;">Delete All Files</button>
            </div>
        `;
        
        modal.appendChild(dialog);
        document.body.appendChild(modal);
        
        document.getElementById('cancel-wipe').onclick = () => {
            document.body.removeChild(modal);
            resolve(false);
        };
        
        document.getElementById('confirm-wipe').onclick = () => {
            document.body.removeChild(modal);
            resolve(true);
        };
        
        // Close on background click
        modal.onclick = (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
                resolve(false);
            }
        };
    });
    
    if (!confirmed) {
        return;
    }
    
    const resultDiv = document.getElementById('cleanup-result');
    resultDiv.innerHTML = '<div class="loading">Wiping imported files...</div>';
    
    try {
        const response = await fetch('/api/cleanup/wipe-files?wipe_database=true&verify=true&dry_run=false', { method: 'POST' });
        const data = await response.json();
        
        let message = `<div class="success">Wipe completed successfully!</div>`;
        message += `<div style="margin-top: 10px;">`;
        message += `<div>Files deleted: ${data.deleted?.length || 0}</div>`;
        if (data.database_deleted) {
            message += `<div>Conversations deleted: ${data.database_deleted.conversations || 0}</div>`;
            message += `<div>Messages deleted: ${data.database_deleted.messages || 0}</div>`;
        }
        message += `</div>`;
        
        if (data.errors && data.errors.length > 0) {
            message += `<div style="margin-top: 10px; color: #e74c3c;">Errors: ${data.errors.length}</div>`;
        }
        
        resultDiv.innerHTML = message;
    } catch (error) {
        resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
    }
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Find Tools - Lode{% endblock %}

{% block content %}
<div class="menu-bar">
    <h1>Lode</h1>
    <div class="menu-items">
        <a href="/main">Main</a>
        <a href="/import">Import</a>
        <a href="/analytics">Analytics</a>
        <a href="/find-tools">Find Tools</a>
        <a href="/export">Export</a>
        <a href="/settings">Settings</a>
        <a href="/help">Help</a>
        <a href="/about">About</a>
    </div>
</div>

<div class="container" style="height: calc(100vh - 60px); display: flex; flex-direction: column; overflow: hidden;">
    <div class="card" style="padding: 16px; display: flex; flex-direction: column; height: 100%; overflow: hidden;">
        <h2 style="margin: 0 0 12px 0; font-size: 20px; flex-shrink: 0;">Find Tools</h2>
        
        <div class="tabs" style="border-bottom: 1px solid #ddd; margin-bottom: 12px; flex-shrink: 0;">
            <button class="tab-btn active" onclick="showTab('code')">Code Blocks</button>
            <button class="tab-btn" onclick="showTab('links')">Links</button>
            <button class="tab-btn" onclick="showTab('todos')">TODOs</button>
            <button class="tab-btn" onclick="showTab('questions')">Questions</button>
            <button class="tab-btn" onclick="showTab('dates')">Dates</button>
            <button class="tab-btn" onclick="showTab('decisions')">Decisions</button>
            <button class="tab-btn" onclick="showTab('prompts')">Prompts</button>
        </div>
        
        <!-- Search and Filters (shown for all tabs) -->
        <div id="find-tools-filters" style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 4px; flex-shrink: 0;">
            <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: #7f8c8d;">Search</label>
                    <input type="text" 
                           id="find-search-input"
                           placeholder="Search results..."
                           style="width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                           onkeyup="debounceFilter()">
                </div>
                <div style="min-width: 150px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: #7f8c8d;">Sort By</label>
                    <select id="find-sort-select" 
                            style="width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                            onchange="applyFilters()">
                        <option value="recent">Most Recent</option>
                        <option value="oldest">Oldest First</option>
                        <option value="relevance">Relevance</option>
                    </select>
                </div>
                <div style="min-width: 120px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: #7f8c8d;">Date From</label>
                    <input type="date" 
                           id="find-date-from"
                           style="width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                           onchange="applyFilters()">
                </div>
                <div style="min-width: 120px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: #7f8c8d;">Date To</label>
                    <input type="date" 
                           id="find-date-to"
                           style="width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                           onchange="applyFilters()">
                </div>
                <div>
                    <button onclick="clearFilters()" 
                            style="padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 14px;">
                        Clear
                    </button>
                </div>
            </div>
        </div>
        
        <div id="tab-content" style="flex: 1; min-height: 0; overflow-y: auto; margin-top: 0;">
            <div id="code-tab" class="tab-panel active">
                <div id="code-data" class="loading">Loading...</div>
            </div>
            
            <div id="links-tab" class="tab-panel">
                <div id="links-data" class="loading">Loading...</div>
            </div>
            
            <div id="todos-tab" class="tab-panel">
                <div id="todos-data" class="loading">Loading...</div>
            </div>
            
            <div id="questions-tab" class="tab-panel">
                <div id="questions-data" class="loading">Loading...</div>
            </div>
            
            <div id="dates-tab" class="tab-panel">
                <div id="dates-data" class="loading">Loading...</div>
            </div>
            
            <div id="decisions-tab" class="tab-panel">
                <div id="decisions-data" class="loading">Loading...</div>
            </div>
            
            <div id="prompts-tab" class="tab-panel">
                <div id="prompts-data" class="loading">Loading...</div>
            </div>
        </div>
    </div>
</div>

<style>
.tabs {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.tab-btn {
    padding: 8px 16px;
    border: none;
    background: transparent;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}

.tab-btn:hover {
    background: #f5f5f5;
}

.tab-btn.active {
    border-bottom-color: #3498db;
    color: #3498db;
}

.tab-panel {
    display: none;
    text-align: left;
}

.tab-panel.active {
    display: block;
    text-align: left;
}

#tab-content {
    text-align: left;
}

/* Compact, IDE-style result cards */
.result-item {
    padding: 8px 12px;
    margin-bottom: 1px;
    background: #fff;
    border-left: 2px solid #e0e0e0;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.1s;
    display: flex;
    flex-direction: column;
    text-align: left;
}

.result-item:hover {
    background: #f8f9fa;
    border-left-color: #3498db;
}

.result-item .result-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 4px;
}

.result-item .result-content {
    font-size: 14px;
    line-height: 1.5;
    color: #333;
    margin-bottom: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.result-item .result-content.full {
    -webkit-line-clamp: unset;
    display: block;
}

.result-item .result-meta {
    font-size: 11px;
    color: #7f8c8d;
    margin-top: 2px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.result-item .result-action {
    font-size: 11px;
    color: #3498db;
    text-decoration: none;
    white-space: nowrap;
    flex-shrink: 0;
}

.result-item .result-action:hover {
    text-decoration: underline;
}

.result-item pre {
    margin: 4px 0 0 0;
    padding: 8px;
    background: #2c3e50;
    color: #ecf0f1;
    border-radius: 3px;
    overflow-x: auto;
    font-size: 12px;
    line-height: 1.4;
    max-height: 300px;
    overflow-y: auto;
}

.result-item code {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 12px;
    background: #f4f4f4;
    padding: 2px 4px;
    border-radius: 2px;
    color: #d63384;
}

.result-item pre code {
    background: transparent;
    padding: 0;
    color: inherit;
}

.result-item a.external-link {
    color: #3498db;
    text-decoration: none;
    word-break: break-all;
}

.result-item a.external-link:hover {
    text-decoration: underline;
}
</style>

<script>
// Store raw data for filtering
let rawData = {
    code: null,
    links: null,
    todos: null,
    questions: null,
    dates: null,
    decisions: null,
    prompts: null
};

let currentTab = 'code';

function showTab(tabName) {
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(`${tabName}-tab`).classList.add('active');
    event.target.classList.add('active');
    currentTab = tabName;
    
    // Reload if we don't have data, otherwise just apply filters
    if (tabName === 'code') {
        if (rawData.code === null) loadCode();
        else applyFilters();
    } else if (tabName === 'links') {
        if (rawData.links === null) loadLinks();
        else applyFilters();
    } else if (tabName === 'todos') {
        if (rawData.todos === null) loadTodos();
        else applyFilters();
    } else if (tabName === 'questions') {
        if (rawData.questions === null) loadQuestions();
        else applyFilters();
    } else if (tabName === 'dates') {
        if (rawData.dates === null) loadDates();
        else applyFilters();
    } else if (tabName === 'decisions') {
        if (rawData.decisions === null) loadDecisions();
        else applyFilters();
    } else if (tabName === 'prompts') {
        if (rawData.prompts === null) loadPrompts();
        else applyFilters();
    }
}

function getFilters() {
    return {
        search: document.getElementById('find-search-input').value.trim().toLowerCase(),
        sort: document.getElementById('find-sort-select').value,
        dateFrom: document.getElementById('find-date-from').value,
        dateTo: document.getElementById('find-date-to').value
    };
}

function filterAndSortData(data, type) {
    const filters = getFilters();
    let filtered = [...data];
    
    // Apply search filter
    if (filters.search) {
        filtered = filtered.filter(item => {
            const searchableText = [
                item.content || '',
                item.text || '',
                item.code || '',
                item.link || item.url || '',
                item.context || '',
                item.title || item.conversation_title || '',
                item.marker || '',
                item.decision_marker || '',
                item.question || '',
                item.date || '',
                item.prompt || ''
            ].join(' ').toLowerCase();
            return searchableText.includes(filters.search);
        });
    }
    
    // Apply date filter
    if (filters.dateFrom || filters.dateTo) {
        filtered = filtered.filter(item => {
            if (!item.create_time) return false;
            const itemDate = new Date(item.create_time * 1000).toISOString().split('T')[0];
            if (filters.dateFrom && itemDate < filters.dateFrom) return false;
            if (filters.dateTo && itemDate > filters.dateTo) return false;
            return true;
        });
    }
    
    // Apply sorting
    if (filters.sort === 'recent') {
        filtered.sort((a, b) => {
            const timeA = a.create_time || 0;
            const timeB = b.create_time || 0;
            return timeB - timeA;
        });
    } else if (filters.sort === 'oldest') {
        filtered.sort((a, b) => {
            const timeA = a.create_time || 0;
            const timeB = b.create_time || 0;
            return timeA - timeB;
        });
    } else if (filters.sort === 'relevance') {
        // For relevance, prioritize items that match search query better
        if (filters.search) {
            filtered.sort((a, b) => {
                const aText = [
                    a.content || '',
                    a.text || '',
                    a.context || ''
                ].join(' ').toLowerCase();
                const bText = [
                    b.content || '',
                    b.text || '',
                    b.context || ''
                ].join(' ').toLowerCase();
                const aIndex = aText.indexOf(filters.search);
                const bIndex = bText.indexOf(filters.search);
                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;
                return 0;
            });
        } else {
            // Default to recent if no search
            filtered.sort((a, b) => {
                const timeA = a.create_time || 0;
                const timeB = b.create_time || 0;
                return timeB - timeA;
            });
        }
    }
    
    return filtered;
}

let filterTimeout = null;
function debounceFilter() {
    if (filterTimeout) clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => applyFilters(), 300);
}

function applyFilters() {
    const tabName = currentTab;
    let data = rawData[tabName];
    if (!data) return;
    
    const filtered = filterAndSortData(data, tabName);
    const div = document.getElementById(`${tabName}-data`);
    
    if (filtered.length === 0) {
        div.innerHTML = `<div class="empty-state" style="padding: 40px; text-align: center; color: #7f8c8d;">No results found${getFilters().search ? ' matching your search' : ''}</div>`;
        return;
    }
    
    let html = `<div style="font-size: 12px; color: #7f8c8d; margin-bottom: 8px; padding: 0 4px;">Found ${filtered.length} result${filtered.length !== 1 ? 's' : ''}${rawData[tabName].length !== filtered.length ? ` (filtered from ${rawData[tabName].length})` : ''}</div>`;
    
    // Helper function to format date/time
    function formatDateTime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp * 1000);
        const dateStr = date.toLocaleDateString();
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        return `${dateStr} ${timeStr}`;
    }
    
    const typeMap = {
        code: 'code',
        links: 'link',
        todos: 'todo',
        questions: 'question',
        dates: 'date',
        decisions: 'decision',
        prompts: 'prompt'
    };
    const resultType = typeMap[tabName] || tabName;

    if (tabName === 'links') {
        filtered.forEach(item => {
            const link = item.link || item.url || '';
            let linkText = link;
            
            if (item.context) {
                const linkIndex = item.context.toLowerCase().indexOf(link.toLowerCase());
                if (linkIndex !== -1) {
                    const afterLink = item.context.substring(linkIndex);
                    const lines = afterLink.split('\n');
                    let firstLine = lines[0].trim();
                    const linkRegex = new RegExp(`^(${link.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s+)+`, 'i');
                    firstLine = firstLine.replace(linkRegex, link + ' ').trim();
                    linkText = firstLine;
                    if (firstLine.length < 100 && lines.length > 1) {
                        linkText = firstLine + ' ' + lines[1].trim();
                    }
                    if (linkText.length > 250) {
                        linkText = linkText.substring(0, 247) + '...';
                    }
                } else {
                    linkText = item.context.length > 250 ? item.context.substring(0, 247) + '...' : item.context;
                }
            }
            
            const title = item.title || item.conversation_title || '';
            let resultHtml = `<div class="result-item">`;
            resultHtml += `<div class="result-header">`;
            resultHtml += `<div style="flex: 1; min-width: 0;">`;
            resultHtml += `<div class="result-content" style="display: flex; align-items: center; gap: 8px;">`;
            resultHtml += `<a href="${link}" target="_blank" class="external-link" style="color: #3498db; font-weight: 500;">${escapeHtml(linkText)}</a>`;
            if (item.conversation_id && item.message_id) {
                resultHtml += `<a href="/main?conversation=${item.conversation_id}&message=${item.message_id}" class="result-action" style="margin-left: auto;">View →</a>`;
            }
            resultHtml += `</div>`;
            resultHtml += `<div class="result-meta">`;
            if (title) {
                resultHtml += `<span>${escapeHtml(title.substring(0, 50))}${title.length > 50 ? '...' : ''}</span>`;
            }
            if (item.create_time) {
                resultHtml += `<span>•</span>`;
                resultHtml += `<span>${formatDateTime(item.create_time)}</span>`;
            }
            resultHtml += `</div>`;
            resultHtml += `</div>`;
            resultHtml += `</div>`;
            resultHtml += `</div>`;
            html += resultHtml;
        });
    } else {
        filtered.forEach(item => {
            // Important: formatResult expects singular type names (todo/question/date/decision/prompt)
            html += formatResult(item, resultType);
        });
    }
    
    div.innerHTML = html;
}

function clearFilters() {
    document.getElementById('find-search-input').value = '';
    document.getElementById('find-sort-select').value = 'recent';
    document.getElementById('find-date-from').value = '';
    document.getElementById('find-date-to').value = '';
    applyFilters();
}

function formatResult(item, type) {
    const convId = item.conversation_id || '';
    const msgId = item.message_id || '';
    const title = item.title || item.conversation_title || '';
    
    // Helper function to format date/time
    function formatDateTime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp * 1000);
        const dateStr = date.toLocaleDateString();
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        return `${dateStr} ${timeStr}`;
    }
    
    // Special handling for TODOs
    if (type === 'todo' && item.marker && item.context) {
        const marker = item.marker;
        let context = item.context;
        
        context = context.trim();
        const markerIndex = context.toLowerCase().indexOf(marker.toLowerCase());
        let todoText = '';
        
        if (markerIndex !== -1) {
            const afterMarker = context.substring(markerIndex);
            const lines = afterMarker.split('\n');
            let firstLine = lines[0].trim();
            
            const markerRegex = new RegExp(`^(${marker}\\s+)+`, 'i');
            firstLine = firstLine.replace(markerRegex, marker + ' ').trim();
            firstLine = firstLine.replace(/^[:-\s]+/, '').trim();
            
            todoText = firstLine;
            if (firstLine.length < 100 && lines.length > 1) {
                const nextLine = lines[1].trim();
                todoText = firstLine + (nextLine ? ' ' + nextLine : '');
            }
            
            if (todoText.length > 250) {
                todoText = todoText.substring(0, 247) + '...';
            }
        } else {
            todoText = context.length > 250 ? context.substring(0, 247) + '...' : context;
        }
        
        let html = `<div class="result-item">`;
        html += `<div class="result-header">`;
        html += `<div style="flex: 1; min-width: 0;">`;
        html += `<div class="result-content" style="display: flex; align-items: center; gap: 8px;">`;
        html += `<span style="color: #e67e22; font-weight: 500;">${escapeHtml(todoText)}</span>`;
        if (convId && msgId) {
            html += `<a href="/main?conversation=${convId}&message=${msgId}" class="result-action" style="margin-left: auto;">View →</a>`;
        }
        html += `</div>`;
        html += `<div class="result-meta">`;
        if (title) {
            html += `<span>${escapeHtml(title.substring(0, 50))}${title.length > 50 ? '...' : ''}</span>`;
        }
        if (item.create_time) {
            html += `<span>•</span>`;
            html += `<span>${formatDateTime(item.create_time)}</span>`;
        }
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
        return html;
    }
    
    // Special handling for Decisions (similar to TODOs)
    if (type === 'decision' && item.decision_marker && item.context) {
        const marker = item.decision_marker;
        let context = item.context;
        
        context = context.trim();
        const markerIndex = context.toLowerCase().indexOf(marker.toLowerCase());
        let decisionText = '';
        
        if (markerIndex !== -1) {
            const afterMarker = context.substring(markerIndex);
            const lines = afterMarker.split('\n');
            let firstLine = lines[0].trim();
            
            const markerRegex = new RegExp(`^(${marker.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s+)+`, 'i');
            firstLine = firstLine.replace(markerRegex, marker + ' ').trim();
            firstLine = firstLine.replace(/^[:-\s]+/, '').trim();
            
            decisionText = firstLine;
            if (firstLine.length < 100 && lines.length > 1) {
                const nextLine = lines[1].trim();
                decisionText = firstLine + (nextLine ? ' ' + nextLine : '');
            }
            
            if (decisionText.length > 250) {
                decisionText = decisionText.substring(0, 247) + '...';
            }
        } else {
            decisionText = context.length > 250 ? context.substring(0, 247) + '...' : context;
        }
        
        let html = `<div class="result-item">`;
        html += `<div class="result-header">`;
        html += `<div style="flex: 1; min-width: 0;">`;
        html += `<div class="result-content" style="display: flex; align-items: center; gap: 8px;">`;
        html += `<span style="color: #27ae60; font-weight: 500;">${escapeHtml(decisionText)}</span>`;
        if (convId && msgId) {
            html += `<a href="/main?conversation=${convId}&message=${msgId}" class="result-action" style="margin-left: auto;">View →</a>`;
        }
        html += `</div>`;
        html += `<div class="result-meta">`;
        if (title) {
            html += `<span>${escapeHtml(title.substring(0, 50))}${title.length > 50 ? '...' : ''}</span>`;
        }
        if (item.create_time) {
            html += `<span>•</span>`;
            html += `<span>${formatDateTime(item.create_time)}</span>`;
        }
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
        return html;
    }
    
    // Special handling for Questions
    if (type === 'question') {
        let questionText = '';
        if (item.context) {
            // Use context if available (full question text)
            questionText = item.context.trim();
        } else if (item.question) {
            // Fallback to question field
            questionText = item.question.trim();
        } else if (item.content) {
            // Extract question from content
            const questions = item.content.match(/[^.!?]*\?[^.!?]*/g);
            if (questions && questions.length > 0) {
                questionText = questions[0].trim();
            } else {
                questionText = item.content.substring(0, 250).trim();
            }
        }
        
        if (questionText.length > 250) {
            questionText = questionText.substring(0, 247) + '...';
        }
        
        let html = `<div class="result-item">`;
        html += `<div class="result-header">`;
        html += `<div style="flex: 1; min-width: 0;">`;
        html += `<div class="result-content" style="display: flex; align-items: center; gap: 8px;">`;
        html += `<span style="color: #3498db; font-weight: 500;">${escapeHtml(questionText)}</span>`;
        if (convId && msgId) {
            html += `<a href="/main?conversation=${convId}&message=${msgId}" class="result-action" style="margin-left: auto;">View →</a>`;
        }
        html += `</div>`;
        html += `<div class="result-meta">`;
        if (title) {
            html += `<span>${escapeHtml(title.substring(0, 50))}${title.length > 50 ? '...' : ''}</span>`;
        }
        if (item.create_time) {
            html += `<span>•</span>`;
            html += `<span>${formatDateTime(item.create_time)}</span>`;
        }
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
        return html;
    }
    
    // Special handling for Dates
    if (type === 'date' && item.date) {
        let dateText = '';
        if (item.context) {
            const dateIndex = item.context.toLowerCase().indexOf(item.date.toLowerCase());
            if (dateIndex !== -1) {
                const afterDate = item.context.substring(dateIndex);
                const lines = afterDate.split('\n');
                let firstLine = lines[0].trim();
                
                const dateRegex = new RegExp(`^(${item.date.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s+)+`, 'i');
                firstLine = firstLine.replace(dateRegex, item.date + ' ').trim();
                firstLine = firstLine.replace(/^[:-\s]+/, '').trim();
                
                dateText = firstLine;
                if (firstLine.length < 100 && lines.length > 1) {
                    const nextLine = lines[1].trim();
                    dateText = firstLine + (nextLine ? ' ' + nextLine : '');
                }
                
                if (dateText.length > 250) {
                    dateText = dateText.substring(0, 247) + '...';
                }
            } else {
                dateText = item.context.length > 250 ? item.context.substring(0, 247) + '...' : item.context;
            }
        } else {
            dateText = item.date;
        }
        
        let html = `<div class="result-item">`;
        html += `<div class="result-header">`;
        html += `<div style="flex: 1; min-width: 0;">`;
        html += `<div class="result-content" style="display: flex; align-items: center; gap: 8px;">`;
        html += `<span style="color: #9b59b6; font-weight: 500;">${escapeHtml(dateText)}</span>`;
        if (convId && msgId) {
            html += `<a href="/main?conversation=${convId}&message=${msgId}" class="result-action" style="margin-left: auto;">View →</a>`;
        }
        html += `</div>`;
        html += `<div class="result-meta">`;
        if (title) {
            html += `<span>${escapeHtml(title.substring(0, 50))}${title.length > 50 ? '...' : ''}</span>`;
        }
        if (item.create_time) {
            html += `<span>•</span>`;
            html += `<span>${formatDateTime(item.create_time)}</span>`;
        }
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
        return html;
    }
    
    // Special handling for Prompts
    if (type === 'prompt') {
        let promptText = '';
        if (item.context) {
            // Use context if available (full prompt text)
            promptText = item.context.trim();
        } else if (item.prompt) {
            // Fallback to prompt field
            promptText = item.prompt.trim();
        } else if (item.content) {
            // Use first line of content
            promptText = item.content.split('\n')[0].trim();
        }
        
        if (promptText.length > 250) {
            promptText = promptText.substring(0, 247) + '...';
        }
        
        let html = `<div class="result-item">`;
        html += `<div class="result-header">`;
        html += `<div style="flex: 1; min-width: 0;">`;
        html += `<div class="result-content" style="display: flex; align-items: center; gap: 8px;">`;
        html += `<span style="color: #8e44ad; font-weight: 500;">${escapeHtml(promptText)}</span>`;
        if (convId && msgId) {
            html += `<a href="/main?conversation=${convId}&message=${msgId}" class="result-action" style="margin-left: auto;">View →</a>`;
        }
        html += `</div>`;
        html += `<div class="result-meta">`;
        if (title) {
            html += `<span>${escapeHtml(title.substring(0, 50))}${title.length > 50 ? '...' : ''}</span>`;
        }
        if (item.create_time) {
            html += `<span>•</span>`;
            html += `<span>${formatDateTime(item.create_time)}</span>`;
        }
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
        return html;
    }
    
    // Default handling for code and other types
    const content = item.content || item.text || item.code || item.link || '';
    
    // Truncate content for display (first 200 chars)
    const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
    const isCode = type === 'code' || content.includes('```') || content.includes('function') || content.includes('class ');
    
    let html = `<div class="result-item">`;
    html += `<div class="result-header">`;
    html += `<div style="flex: 1; min-width: 0;">`;
    
    // Primary content line
    if (isCode) {
        html += `<pre><code>${escapeHtml(content.substring(0, 500))}${content.length > 500 ? '...' : ''}</code></pre>`;
    } else {
        html += `<div class="result-content">${escapeHtml(preview)}</div>`;
    }
    
    // Metadata line
    html += `<div class="result-meta">`;
    if (title) {
        html += `<span>${escapeHtml(title.substring(0, 40))}${title.length > 40 ? '...' : ''}</span>`;
    }
    if (convId) {
        html += `<span>•</span>`;
        html += `<span>${convId.substring(0, 16)}${convId.length > 16 ? '...' : ''}</span>`;
    }
    if (msgId) {
        html += `<span>•</span>`;
        html += `<span>${msgId.substring(0, 12)}${msgId.length > 12 ? '...' : ''}</span>`;
    }
    html += `</div>`;
    html += `</div>`;
    
    // Action link (right-aligned)
    if (convId && msgId) {
        html += `<a href="/main?conversation=${convId}&message=${msgId}" class="result-action">View →</a>`;
    }
    html += `</div>`;
    html += `</div>`;
    return html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function loadCode() {
    const div = document.getElementById('code-data');
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/find/code?limit=500');
        const data = await response.json();
        rawData.code = data;
        applyFilters();
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

async function loadLinks() {
    const div = document.getElementById('links-data');
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/find/links?limit=500');
        const data = await response.json();
        rawData.links = data;
        applyFilters();
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

async function loadTodos() {
    const div = document.getElementById('todos-data');
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/find/todos?limit=500');
        const data = await response.json();
        rawData.todos = data;
        applyFilters();
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

async function loadQuestions() {
    const div = document.getElementById('questions-data');
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/find/questions?limit=500');
        const data = await response.json();
        rawData.questions = data;
        applyFilters();
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

async function loadDates() {
    const div = document.getElementById('dates-data');
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/find/dates?limit=500');
        const data = await response.json();
        rawData.dates = data;
        applyFilters();
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

async function loadDecisions() {
    const div = document.getElementById('decisions-data');
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/find/decisions?limit=500');
        const data = await response.json();
        rawData.decisions = data;
        applyFilters();
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

async function loadPrompts() {
    const div = document.getElementById('prompts-data');
    div.innerHTML = '<div class="loading">Loading...</div>';
    
    try {
        const response = await fetch('/api/find/prompts?limit=500');
        const data = await response.json();
        rawData.prompts = data;
        applyFilters();
    } catch (error) {
        div.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

// Load initial tab
loadCode();
</script>
{% endblock %}
